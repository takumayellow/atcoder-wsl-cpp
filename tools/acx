#!/usr/bin/env bash
set -e

# --- PATH SETUP START ---
# Ensure acc and oj are in PATH for non-interactive shells
export PATH="$HOME/.local/bin:$PATH"

# Try to find acc in NVM directories if not found or if found in /mnt (Windows path)
ACC_PATH=$(command -v acc || true)
if [[ -z "$ACC_PATH" ]] || [[ "$ACC_PATH" == /mnt/* ]]; then
    # Try to source NVM if available
    export NVM_DIR="$HOME/.nvm"
    if [ -s "$NVM_DIR/nvm.sh" ]; then
        . "$NVM_DIR/nvm.sh"
    elif [ -d "$HOME/.nvm/versions/node" ]; then
        # Fallback: add the latest node version bin to PATH manually
        LATEST_NODE=$(ls -d $HOME/.nvm/versions/node/v* | sort -V | tail -n 1)
        if [ -n "$LATEST_NODE" ]; then
            export PATH="$LATEST_NODE/bin:$PATH"
        fi
    fi
fi
# --- PATH SETUP END ---

# Detect Repo Root
SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
REPO_ROOT=$(dirname "$SCRIPT_DIR")
R="$REPO_ROOT"
S="$HOME/.config/acx/last"
mkdir -p "${S%/*}"

CID=${1:-}
P=${2:-}
TEMPLATE_OPT=""

# Argument parsing helpe
# Check if any argument is "py" or "python" to set mode
for arg in "$@"; do
    if [[ "$arg" == "py" || "$arg" == "python" ]]; then
        TEMPLATE_OPT="python"
        break
    fi
done

# If first arg is empty, try to load last contest
if [ -z "$CID" ] || [[ "$CID" == "py" || "$CID" == "python" ]]; then
    if [ -f "$S" ]; then
        CID=$(cat "$S")
    else
        echo "usage: acx <contest-id> [problem] [py]"
        exit 1
    fi
fi

# Logic to handle "acx a" -> implies last contest, problem a
# If CID is single char (problem) and P is empty/py, swap
if [[ "$CID" =~ ^[a-z]$ ]]; then
    P=$CID
    if [ -f "$S" ]; then
        CID=$(cat "$S")
    else
        echo "No previous contest found."
        exit 1
    fi
fi

# Clean up P
if [[ "$P" == "py" || "$P" == "python" ]]; then P=""; fi
P=${P:-a}
P=${P,,}

cd "$R"

# Create contest if missing
if [ ! -d "$CID" ]; then
    echo "Creating contest workspace for $CID..."
    if [[ "$TEMPLATE_OPT" == "python" ]]; then
        acc new "$CID" --template python
    else
        acc new "$CID" --template cpp
    fi
fi

TARGET_DIR="$R/$CID/$P"
if [ ! -d "$TARGET_DIR" ]; then
    echo "Directory $TARGET_DIR does not exist. Did acc new fail?"
    # Try creating just this problem directory if acc failed to scaffold deep?
    # Usually acc new creates everything.
    exit 1
fi

cd "$TARGET_DIR"

# Save state
echo "$CID" > "$S"

# Determine file to open
FILE_TO_OPEN=""
if [ -f "main.py" ]; then
    FILE_TO_OPEN="main.py"
elif [ -f "main.cpp" ]; then
    FILE_TO_OPEN="main.cpp"
else
    # Create if missing based on intent
    if [[ "$TEMPLATE_OPT" == "python" ]]; then
        cp "$REPO_ROOT/tools/templates/python/main.py" .
        FILE_TO_OPEN="main.py"
    else
        cp "$REPO_ROOT/tools/templates/cpp/main.cpp" .
        FILE_TO_OPEN="main.cpp"
    fi
    # Also copy template.json if missing for acc to work?
    # usually acc needs template.json to know what to submit.
fi

echo "Ready in $TARGET_DIR"

# Output the file path for the calling script (acx.bat) to open
# Format: OPEN:<full_path>
echo "OPEN:$TARGET_DIR/$FILE_TO_OPEN"
